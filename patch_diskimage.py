import sys
import numpy as np

patch_old=[0x75, 0x48, 0x08, 0x0e, 0x00, 0x51, 0x00,\
    0x08, 0x00, 0x02, 0x00, 0x4b, 0x00,\
    0x2f, 0xa9, 0x00, 0x42, 0x00,\
    0x6f, 0x72, 0x00, 0x1d, 0x00,\
    0xd8, 0x54, 0x68, 0x69, 0xf3, 0x6c, 0x6f, 0x6f, 0x6b, 0xf3, 0x6c, 0x69, 0x6b, 0xe5, 0x61, 0xee, 0x61, 0x72, 0x74, 0x69, 0x66, 0x61, 0x63, 0x74, 0x21, 0x00,\
    0x18, 0x20, 0x00, \
    0xd8, 0xc9, 0x77, 0x6f, 0x6e, 0x64, 0x65, 0xf2, 0x77, 0x68, 0xef, 0x77, 0x6f, 0x75, 0x6c, 0xe4, 0x6b, 0x6e, 0x6f, 0xf7, 0x77, 0x68, 0x61, 0xf4, 0x74, 0x68, 0x69, 0xf3, 0x69, 0x73, 0x2e, 0x00, \
    0xd0, 0x09, 0x62, 0x00]

patch_new=[0x77, 0x48, 0x08, 0x0e, 0x00, 0x51, 0x00,\
    0xd0, 0x09, \
    0x08, 0x00, 0x02, 0x00, 0x49, 0x00, \
    0x2f, 0xa9, 0x00, 0x42, 0x00, \
    0x6f, 0x72, 0x00, 0x1d, 0x00, \
    0xd8, 0x54, 0x68, 0x69, 0xf3, 0x6c, 0x6f, 0x6f, 0x6b, 0xf3, 0x6c, 0x69, 0x6b, 0xe5, 0x61, 0xee, 0x61, 0x72, 0x74, 0x69, 0x66, 0x61, 0x63, 0x74, 0x21, 0x00,\
    0x18, 0x20, 0x00,\
    0xd8, 0xc9, 0x77, 0x6f, 0x6e, 0x64, 0x65, 0xf2, 0x77, 0x68, 0xef, 0x77, 0x6f, 0x75, 0x6c, 0xe4, 0x6b, 0x6e, 0x6f, 0xf7, 0x77, 0x68, 0x61, 0xf4, 0x74, 0x68, 0x69, 0xf3, 0x69, 0x73, 0x2e, 0x00, \
    0x62, 0x00 ]

position = 0xee47

infile=open(sys.argv[1],'rb')
data=list(bytearray(infile.read()))
data=np.array(data,dtype='uint8')
original_array=np.array(patch_old)
new_array=np.array(patch_new)

if (data[position:position+len(original_array)] != original_array).all():
    print ('Bad disk image')
    sys.exit(1)
data[position:position+len(original_array)] = new_array
outfile=open(sys.argv[1][:-4]+'-patch.d64','wb')
outfile.write((data.tobytes()))
outfile.close()
print ('Patched disk image written: ',sys.argv[1][:-4]+'-patch.d64')
